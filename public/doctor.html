<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Crop Doctor | Farm Central</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
            margin: 0;
        }

        /* Global Interactive Hover Effects */
        button:hover,
        input:hover,
        .glass:hover,
        a:hover {
            transform: scale(1.02);
            /* "Small and Big" effect */
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }

        /* Scan Line Animation */
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(52, 211, 153, 0.4), transparent);
            transform: translateY(-100%);
            animation: scan 2s infinite linear;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="p-6 md:p-12">
    <div id="canvas-bg" class="fixed inset-0 z-[-1] opacity-50"></div>

    <!-- Back Button (Global Position) -->
    <button onclick="window.history.back()"
        class="fixed top-6 left-6 z-50 w-12 h-12 rounded-full glass flex items-center justify-center text-white hover:bg-white/10 transition hover:scale-110 shadow-lg">
        ‚Üê
    </button>

    <div class="max-w-4xl mx-auto pt-10">
        <header class="flex justify-between items-center mb-12 pl-12">
            <div>
                <h1
                    class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500">
                    AI CROP DOCTOR</h1>
                <p class="text-slate-400 font-medium">Advanced Plant Disease Diagnosis System</p>
            </div>
            <!-- Removed Dashboard/Hub Button -->
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">

            <!-- Upload Section -->
            <div class="glass p-8 rounded-3xl border border-white/5 relative overflow-hidden">
                <h2 class="text-xl font-bold mb-6 text-white flex items-center gap-2">
                    <span class="bg-emerald-500/20 text-emerald-400 p-2 rounded-lg">üì∏</span> Upload Sample
                </h2>

                <!-- Camera option -->
                <div class="flex gap-4 mb-4">
                    <button onclick="document.getElementById('cameraBtn').click()"
                        class="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
                        <span>üì∑</span> Take Photo
                    </button>
                    <input type="file" id="cameraBtn" capture="environment" accept="image/*" class="hidden"
                        onchange="showPreview(this)">
                </div>

                <div id="drop-zone"
                    class="border-2 border-dashed border-slate-600 rounded-2xl p-6 text-center hover:bg-slate-800/50 transition cursor-pointer"
                    onclick="document.getElementById('fileIn').click()">
                    <div id="preview-area" class="hidden relative rounded-xl overflow-hidden mb-4 h-64">
                        <img id="preview-img" class="w-full h-full object-cover">
                        <div id="scanner" class="scan-overlay hidden"></div>
                    </div>

                    <div id="upload-prompt">
                        <div class="text-4xl mb-4">üì§</div>
                        <p class="text-slate-300 font-bold">Select from Gallery</p>
                    </div>
                </div>

                <input type="file" id="fileIn" class="hidden" accept="image/*" onchange="showPreview(this)">

                <button onclick="analyzeCrop()" id="analyzeBtn" disabled
                    class="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white py-4 rounded-xl font-bold tracking-wider transition shadow-lg shadow-emerald-500/20">
                    DIAGNOSE NOW
                </button>
            </div>

            <!-- Analysis Result -->
            <div id="result-card" class="glass p-8 rounded-3xl border border-white/5 hidden animate-fade-in-up">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-xs text-slate-500 font-mono" id="scan-id">ID: SCN-29384</p>
                        <h2 class="text-3xl font-black text-white mt-1" id="disease-name">...</h2>
                    </div>
                    <div class="bg-slate-800 px-4 py-2 rounded-lg border border-white/10 text-center">
                        <p class="text-xs text-slate-400">CONFIDENCE</p>
                        <p class="text-xl font-bold text-emerald-400" id="confidence-score">0%</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold text-slate-300 mb-2 uppercase text-xs tracking-widest">Recommended
                            Treatment</h3>
                        <p class="text-slate-400 leading-relaxed bg-slate-900/50 p-4 rounded-xl border-l-4 border-emerald-500"
                            id="treatment-plan">
                            ...
                        </p>
                    </div>

                    <div>
                        <h3 class="font-bold text-slate-300 mb-2 uppercase text-xs tracking-widest">Next Actions</h3>
                        <div class="flex gap-3">
                            <button onclick="saveReport()" id="saveBtn"
                                class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                                <span>üíæ</span> Save Report to History
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Past Reports Link -->
            <button onclick="location.href='reports.html'"
                class="text-slate-500 hover:text-white underline text-sm">View Past Reports</button>
        </div>

        <!-- Empty State Right Side -->
        <div id="placeholder-card"
            class="glass p-8 rounded-3xl border border-white/5 flex flex-col items-center justify-center text-center h-full min-h-[400px]">
            <div class="text-6xl mb-6 opacity-20">üî¨</div>
            <h3 class="text-xl font-bold text-slate-300">Ready for Analysis</h3>
            <p class="text-slate-500 mt-2 max-w-xs">AI Doctor scans leaf patterns to detect nitrogen deficiency,
                blight, pests, and more.</p>
        </div>

    </div>
    </div>

    <script>
        // --- 3D DNA Helix / Network Simulation ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-bg').appendChild(renderer.domElement);

        const geometry = new THREE.IcosahedronGeometry(10, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x10b981, wireframe: true, transparent: true, opacity: 0.1 });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        // Particles
        const pGeo = new THREE.BufferGeometry();
        const pCount = 200;
        const pArr = new Float32Array(pCount * 3);
        for (let i = 0; i < pCount * 3; i++) pArr[i] = (Math.random() - 0.5) * 50;
        pGeo.setAttribute('position', new THREE.BufferAttribute(pArr, 3));
        const pMat = new THREE.PointsMaterial({ size: 0.1, color: 0x34d399 });
        const particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);

        camera.position.z = 20;

        function animate() {
            requestAnimationFrame(animate);
            sphere.rotation.y += 0.002;
            sphere.rotation.x += 0.001;
            particles.rotation.y -= 0.001;
            renderer.render(scene, camera);
        }
        animate();

        // --- AUTH ---
        const token = localStorage.getItem('token');
        if (!token) location.href = 'index.html';

        // --- UI LOGIC ---
        // Global state for last analysis
        let lastAnalysisResult = null;
        let selectedFile = null;

        function showPreview(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-area').classList.remove('hidden');
                    document.getElementById('upload-prompt').classList.add('hidden');
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('result-card').classList.add('hidden');
                    document.getElementById('placeholder-card').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Load MobileNet ---
        let mobilenetModel = null;
        async function loadMobileNet() {
            try {
                // Initialize model from CDN
                mobilenetModel = await mobilenet.load();
                console.log("MobileNet Loaded");
            } catch (e) {
                console.warn("Offline or failed to load MobileNet:", e);
            }
        }
        // Load on start
        if (window.mobilenet) loadMobileNet();
        else {
            // Inject script dynamically
            const s1 = document.createElement('script');
            s1.src = "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs";
            document.head.appendChild(s1);
            s1.onload = () => {
                const s2 = document.createElement('script');
                s2.src = "https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet";
                document.head.appendChild(s2);
                s2.onload = loadMobileNet;
            }
        }

        // Typewriter Effect utility
        function typeWriter(elementId, text, speed = 10) {
            const el = document.getElementById(elementId);
            el.innerHTML = '';
            let i = 0;
            function type() {
                if (i < text.length) {
                    el.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        async function analyzeCrop() {
            const btn = document.getElementById('analyzeBtn');
            const scanner = document.getElementById('scanner');

            if (!selectedFile) {
                alert("Please select or capture an image first.");
                return;
            }

            // UI Loading
            btn.disabled = true;
            btn.innerText = "INITIALIZING VISION ENGINE...";
            scanner.classList.remove('hidden');

            // 1. Client-Side Validation (MobileNet)
            if (mobilenetModel) {
                const imgEl = document.getElementById('preview-img');
                try {
                    const predictions = await mobilenetModel.classify(imgEl);
                    const plantKeywords = ['plant', 'leaf', 'flower', 'vegetable', 'fruit', 'tree', 'corn', 'herb', 'broccoli', 'cauliflower', 'cabbage', 'cucumber', 'zucchini', 'ant', 'beetle', 'pot'];
                    const isPlant = predictions.some(p => plantKeywords.some(k => p.className.toLowerCase().includes(k)) || p.probability > 0.1);

                    // Strict check
                    const nonPlantKeywords = ['paper', 'wallet', 'money', 'cash', 'pay', 'keyboard', 'phone'];
                    // Increased threshold to 0.45 and ensure it's NOT a plant
                    const isClearlyNotPlant = predictions.some(p => nonPlantKeywords.some(k => p.className.toLowerCase().includes(k)) && p.probability > 0.45);

                    // If we found ANY trace of a plant (> 0.05), we override the rejection because it might be a plant next to a phone
                    const isLikelyPlant = predictions.some(p => plantKeywords.some(k => p.className.toLowerCase().includes(k)) && p.probability > 0.05);

                    if (isClearlyNotPlant && !isLikelyPlant) {
                        alert("‚ö†Ô∏è Image Rejected.\n\nVision Guard detected non-crop object (" + predictions[0].className + ").\n\nPlease ensure the photo contains a clear view of the crop leaf.");
                        scanner.classList.add('hidden');
                        btn.innerText = "DIAGNOSE NOW";
                        btn.disabled = false;
                        return;
                    }
                } catch (e) { console.log("Validation Skipped", e); }
            }

            // 2. Proceed to Backend
            btn.innerText = "ANALYZING PATTERNS...";
            const formData = new FormData();
            formData.append('image', selectedFile);

            try {
                // Simulate progressive loading steps
                setTimeout(() => { btn.innerText = "IDENTIFYING PATHOGENS..."; }, 1000);
                setTimeout(() => { btn.innerText = "GENERATING REPORT..."; }, 2000);

                const res = await fetch('/api/doctor/analyze', {
                    method: 'POST',
                    headers: { 'Authorization': token },
                    body: formData
                });
                const data = await res.json();
                lastAnalysisResult = data;

                scanner.classList.add('hidden');
                btn.innerText = "DIAGNOSE NOW";
                btn.disabled = false;

                // Show Results
                document.getElementById('placeholder-card').classList.add('hidden');
                document.getElementById('result-card').classList.remove('hidden');

                document.getElementById('scan-id').innerText = `ID: ${data.scan_id}`;
                document.getElementById('disease-name').innerText = data.diagnosis;

                // Add scientific name if element exists, or append
                if (!document.getElementById('sci-name')) {
                    const sn = document.createElement('p');
                    sn.id = 'sci-name';
                    sn.className = 'text-sm text-cyan-400 italic font-mono mb-2';
                    document.getElementById('disease-name').after(sn);
                }
                document.getElementById('sci-name').innerText = data.scientific_name;

                document.getElementById('confidence-score').innerText = data.confidence;

                // Format Treatment (Rich HTML)
                let treatmentHTML = `
                    <div class="space-y-4">
                        <p class="text-sm text-slate-300"><strong>Symptoms detected:</strong> ${data.symptoms}</p>
                        
                        <div class="bg-emerald-900/20 p-3 rounded-lg border border-emerald-500/30">
                            <h4 class="text-emerald-400 font-bold text-sm mb-2">üå± Organic Cure</h4>
                            <ul class="list-disc list-inside text-slate-300 text-sm space-y-1">
                                ${data.treatment.organic.map(step => `<li>${step}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30">
                            <h4 class="text-blue-400 font-bold text-sm mb-2">üß™ Chemical Cure</h4>
                            <ul class="list-disc list-inside text-slate-300 text-sm space-y-1">
                                ${data.treatment.chemical.map(step => `<li>${step}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="bg-slate-700/30 p-3 rounded-lg">
                            <h4 class="text-slate-200 font-bold text-sm mb-1">üõ°Ô∏è Future Prevention</h4>
                            <p class="text-slate-400 text-sm">${data.prevention}</p>
                        </div>
                    </div>
                `;

                document.getElementById('treatment-plan').innerHTML = treatmentHTML;

                if (data.diagnosis === 'Healthy Crop') {
                    document.getElementById('disease-name').className = 'text-3xl font-black text-green-400 mt-1';
                } else {
                    document.getElementById('disease-name').className = 'text-3xl font-black text-red-500 mt-1';
                }

                // TTS
                speak(`Analysis complete. Detected ${data.diagnosis}. Confidence ${data.confidence}.`);

            } catch (e) {
                console.error(e);
                alert("Analysis Failed. Please try again.");
                scanner.classList.add('hidden');
                btn.innerText = "DIAGNOSE NOW";
                btn.disabled = false;
            }
        }

        // --- TTS & REPORT SAVING ---
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            // Optional: Try to find an Indian English or local voice if available
            // const voices = window.speechSynthesis.getVoices();
            // utterance.voice = voices.find(v => v.lang.includes('IN')) || voices[0];
            window.speechSynthesis.speak(utterance);
        }



        async function saveReport() {
            if (!lastAnalysisResult) return;
            const btn = document.getElementById('saveBtn');

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const res = await fetch('/api/doctor/save-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        scan_id: lastAnalysisResult.scan_id,
                        diagnosis: lastAnalysisResult.diagnosis,
                        confidence: lastAnalysisResult.confidence,
                        treatment: lastAnalysisResult.treatment,
                        image_url: lastAnalysisResult.image_url
                    })
                });

                if (res.ok) {
                    btn.innerHTML = "<span>‚úÖ</span> Saved to History";
                    setTimeout(() => {
                        btn.innerHTML = "<span>üíæ</span> Save Report to History";
                        btn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error("Failed");
                }
            } catch (e) {
                alert("Failed to save report.");
                btn.disabled = false;
                btn.innerText = "Save Report to History";
            }
        }
    </script>
    <script src="js/ai-core.js"></script>
    <script src="js/background-3d.js"></script>
    <script src="js/global-ticker.js"></script>
    <script src="js/mobile-nav.js"></script>
</body>

</html>