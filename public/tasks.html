<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Smart Farm - Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #020617;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
        }

        #canvas-wrap {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="p-8">
    <div id="canvas-wrap"></div>

    <div class="max-w-4xl mx-auto relative z-10">
        <!-- Back Button -->
        <button onclick="window.history.back()"
            class="fixed top-6 left-6 z-50 w-12 h-12 rounded-full glass-panel flex items-center justify-center text-white hover:bg-white/10 transition hover:scale-110 shadow-lg">
            ←
        </button>

        <div class="flex justify-between items-center mb-8 pl-14">
            <h1 class="text-3xl font-bold text-blue-400">Farm Chores</h1>
            <!-- Hub Button Removed -->
        </div>

        <form id="taskInput" class="glass-panel p-6 rounded-2xl flex flex-wrap gap-4 mb-8">
            <input type="date" id="tDate" required class="bg-black/40 p-2 rounded border border-white/20">
            <input type="time" id="tTime" required class="bg-black/40 p-2 rounded border border-white/20">
            <input type="text" id="tDesc" placeholder="What needs to be done?" required
                class="flex-1 bg-black/40 p-2 rounded border border-white/20">
            <button type="submit" class="bg-blue-600 px-6 py-2 rounded font-bold hover:bg-blue-500">Save Task</button>
        </form>

        <div id="taskDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4 h-[60vh] overflow-y-auto pr-2"></div>
    </div>

    <script>
        // --- 3D ENVIRONMENT ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-wrap').appendChild(renderer.domElement);

        const shape = new THREE.Mesh(new THREE.IcosahedronGeometry(10, 1), new THREE.MeshNormalMaterial({ wireframe: true }));
        scene.add(shape);
        camera.position.z = 25;

        function animate() {
            requestAnimationFrame(animate);
            shape.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();

        // --- APP LOGIC ---
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'dashboard.html';

        async function loadTasks() {
            const res = await fetch('/api/tasks', { headers: { 'Authorization': token } });
            const data = await res.json();
            document.getElementById('taskDisplay').innerHTML = data.map(t => `
                <div class="glass-panel p-4 rounded-xl border-l-4 border-blue-500 relative group">
                    <button onclick="deleteTask(${t.id})" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-300 transition">
                       ✕
                    </button>
                    <p class="text-xs text-blue-300">${t.task_date.split('T')[0]} @ ${t.task_time}</p>
                    <p class="text-lg font-semibold">${t.description}</p>
                </div>
            `).join('');
        }

        async function deleteTask(id) {
            if (!confirm("Complete/Delete this task?")) return;
            const res = await fetch(`/api/tasks/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            });
            if (res.ok) loadTasks();
        }

        document.getElementById('taskInput').onsubmit = async (e) => {
            e.preventDefault();
            const bodyData = {
                task_date: document.getElementById('tDate').value,
                task_time: document.getElementById('tTime').value,
                description: document.getElementById('tDesc').value
            };

            const res = await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify(bodyData)
            });

            if (res.ok) {
                document.getElementById('taskInput').reset();
                loadTasks();
            } else {
                alert("Database error. Check terminal.");
            }
        };

        loadTasks();
    </script>
    <script src="js/background-3d.js"></script>
    <script src="js/global-ticker.js"></script>
    <script src="js/mobile-nav.js"></script>
</body>

</html>