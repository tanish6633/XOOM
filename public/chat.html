<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Farm Chat | Next Gen</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            /* Normalized Design - Removed Heavy Glass Effects */
            --glass-bg: #1e293b;
            /* Solid Dark Slate */
            --glass-border: #334155;
            --accent-primary: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --msg-own: #10b981;
            /* Solid Green */
            --msg-other: #334155;
            --bg-dark: #0f172a;
        }

        body {
            background: var(--bg-dark);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Outfit', sans-serif;
        }

        /* Standard Panels (No Blur) */
        .glass-panel {
            background: var(--glass-bg);
            border-right: 1px solid var(--glass-border);
        }

        .glass-header {
            background: #1e293b;
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chat-area {
            background: #0f172a;
            /* Solid Background */
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Modern Message Bubbles */
        .msg-bubble {
            max-width: 70%;
            padding: 14px 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .my-msg {
            background: var(--msg-own);
            color: white;
            border-radius: 20px 20px 4px 20px;
            /* Top-Left, Top-Right, Bottom-Right (Sharp), Bottom-Left */
            margin-right: 4px;
            box-shadow: 0 4px 15px -3px var(--accent-glow);
        }

        .their-msg {
            background: var(--msg-other);
            color: #e2e8f0;
            border-radius: 20px 20px 20px 4px;
            /* Sharp Bottom-Left */
            margin-left: 4px;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Sidebar Item - Active State */
        .chat-item.active {
            background: rgba(255, 255, 255, 0.08);
            /* Lighter bg */
            border-left: 3px solid var(--accent-primary);
        }

        /* Floating Input Area */
        .input-dock {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Interactive Hover Effects */
        button,
        .hover-scale {
            transition: transform 0.2s ease, background-color 0.2s;
        }

        button:active {
            transform: scale(0.96);
        }

        /* Call Modal Overlay */
        #call-modal {
            background: rgba(0, 0, 0, 0.85);
            /* Darker backdrop */
            backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="flex" style="background: transparent;">
    <div id="canvas-bg"></div>

    <!-- Back Button -->
    <button onclick="window.history.back()"
        class="fixed top-6 left-6 z-50 w-12 h-12 rounded-full bg-slate-800/80 flex items-center justify-center text-white hover:bg-white/10 transition hover:scale-110 shadow-lg border border-white/10">
        ‚Üê
    </button>

    <!-- Sidebar (Contacts) -->
    <div id="sidebar"
        class="w-full md:w-80 glass-panel h-full flex flex-col z-20 absolute md:relative transition-transform duration-300 md:translate-x-0 -translate-x-full border-r border-white/5">

        <!-- Sidebar Header -->
        <div class="p-6 pb-2 pl-12 pt-16 md:pl-6 md:pt-8 bg-slate-900/30">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-white tracking-tight brand-font">FarmChat</h2>
                </div>

                <div class="flex gap-2 items-center">
                    <button onclick="localStorage.clear(); location.href='index.html'"
                        class="p-2 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-red-400 transition"
                        title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                    </button>
                    <!-- Status Indicator -->
                    <div class="h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981] animate-pulse"></div>
                </div>
            </div>

            <!-- Search -->
            <div class="relative group mt-4">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-slate-500 group-focus-within:text-emerald-500 transition" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" id="userSearch" placeholder="Search farmers..."
                    class="w-full bg-slate-800/50 text-sm text-white pl-10 pr-4 py-2.5 rounded-lg border border-slate-700/50 outline-none focus:border-emerald-500/50 focus:bg-slate-800 focus:ring-1 focus:ring-emerald-500/20 transition placeholder-slate-500"
                    oninput="searchUsers(this.value)">
            </div>
        </div>

        <!-- Recent Chats List -->
        <div id="conversationsList" class="flex-1 overflow-y-auto px-3 py-2 space-y-1 custom-scrollbar">
            <!-- Injected via JS -->
            <div class="flex flex-col items-center justify-center h-40 text-slate-500 gap-2">
                <div class="w-6 h-6 border-2 border-slate-600 border-t-emerald-500 rounded-full animate-spin"></div>
                <span class="text-xs font-medium">Loading conversations...</span>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="flex-1 flex flex-col chat-area relative w-full h-full">

        <!-- Header -->
        <div id="chat-header" class="h-20 px-6 flex justify-between items-center glass-header z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-white p-2">‚ò∞</button>

                <div id="header-avatar"
                    class="hidden w-11 h-11 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg border-2 border-slate-700">
                    ?</div>
                <div>
                    <h3 id="chat-name" class="text-xl font-bold text-slate-100 tracking-wide brand-font">Select a Chat
                    </h3>
                    <p id="chat-status" class="text-xs text-green-400 hidden flex items-center gap-1.5 font-medium">
                        <span
                            class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse ring-4 ring-green-500/20"></span>
                        Online
                    </p>
                </div>
            </div>

            <!-- Call Actions -->
            <div id="call-actions" class="hidden flex gap-3">
                <button onclick="startCall('voice')"
                    class="w-10 h-10 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-200 flex items-center justify-center transition border border-white/5"
                    title="Voice Call">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                        </path>
                    </svg>
                </button>
                <button onclick="startCall('video')"
                    class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/30 flex items-center justify-center transition transform hover:-translate-y-1"
                    title="Video Call">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="msgContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 flex flex-col scroll-smooth">
            <div class="flex-1 flex flex-col items-center justify-center select-none text-slate-500/30">
                <svg class="w-32 h-32 mb-4 opacity-50" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                </svg>
                <p class="text-xl font-bold brand-font text-slate-500">Farm Chat</p>
                <p class="text-sm font-medium">Select a contact to start messaging</p>
            </div>
        </div>

        <!-- Smart Replies -->
        <div id="smart-replies"
            class="px-6 py-2 flex gap-3 overflow-x-auto hidden bg-slate-900/50 backdrop-blur-sm border-t border-white/5 no-scrollbar">
        </div>

        <!-- Input Dock -->
        <div id="input-area" class="input-dock p-4 md:px-8 md:py-6">
            <!-- Preview Attachment -->
            <div id="attachment-preview"
                class="hidden px-4 py-3 mb-2 border border-white/10 flex justify-between items-center bg-slate-800/80 rounded-xl mx-1 shadow-lg backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <span class="text-xl">üìé</span>
                    <span id="file-name"
                        class="text-xs text-slate-300 font-mono truncate max-w-[200px]">image.png</span>
                </div>
                <button onclick="clearAttachment()"
                    class="text-rose-400 hover:text-rose-300 text-xs font-bold px-2 py-1 rounded hover:bg-white/5 transition">REMOVE</button>
            </div>

            <form id="chatForm" class="flex items-center gap-3 max-w-6xl mx-auto relative">
                <!-- Attach Button -->
                <label
                    class="flex-shrink-0 w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 cursor-pointer text-slate-400 hover:text-emerald-400 transition flex items-center justify-center border border-white/5 hover:border-emerald-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                        </path>
                    </svg>
                    <input type="file" id="mediaInput" class="hidden" accept="image/*,video/*"
                        onchange="handleFile(this)">
                </label>

                <!-- Voice Msg Button -->
                <button type="button" id="recordBtn"
                    class="flex-shrink-0 w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-red-400 transition flex items-center justify-center border border-white/5"
                    onclick="toggleRecording()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                        </path>
                    </svg>
                </button>

                <div class="flex-1 relative">
                    <input type="text" id="msgInput" disabled placeholder="Type a message..." autocomplete="off"
                        class="w-full bg-slate-800 text-white pl-5 pr-4 py-4 rounded-full outline-none focus:ring-2 focus:ring-emerald-500/50 transition border border-transparent focus:border-emerald-500/30 placeholder-slate-500 shadow-inner">
                </div>

                <button type="submit" id="sendBtn" disabled
                    class="flex-shrink-0 w-12 h-12 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full font-bold transition shadow-lg shadow-emerald-500/30 flex items-center justify-center transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>

        <!-- Recording Overlay -->
        <div id="recording-ui"
            class="hidden absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-lg animate-pulse flex items-center gap-3 z-50">
            <div class="w-3 h-3 bg-white rounded-full"></div>
            <span class="font-bold tracking-widest">RECORDING...</span>
            <button onclick="cancelRecording()"
                class="ml-4 text-xs bg-black/20 px-2 py-1 rounded hover:bg-black/40">CANCEL</button>
        </div>
    </div>

    <!-- Video Call Modal -->
    <div id="call-modal"
        class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-4 backdrop-blur-xl bg-slate-900/90 transition-opacity duration-300">
        <div
            class="relative w-full max-w-5xl aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/10 flex flex-col group">

            <!-- Header Overlay -->
            <div
                class="absolute top-0 left-0 right-0 p-8 bg-gradient-to-b from-black/80 to-transparent z-10 flex justify-between items-start pointer-events-none">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse absolute top-0 right-0"></div>
                        <div
                            class="w-12 h-12 rounded-xl bg-white/10 backdrop-blur-md flex items-center justify-center text-2xl">
                            üë§</div>
                    </div>
                    <div>
                        <span id="call-status-text"
                            class="text-white font-bold tracking-wider text-sm md:text-lg drop-shadow-md">Connecting...</span>
                        <div class="text-white/60 text-xs md:text-sm font-mono mt-1" id="call-timer">00:00</div>
                    </div>
                </div>
            </div>

            <!-- Main Video (Remote) -->
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover bg-slate-900"></video>

            <!-- Self Video (PIP) -->
            <div
                class="absolute bottom-32 right-8 w-32 md:w-64 aspect-video bg-slate-800 rounded-2xl overflow-hidden shadow-2xl border-2 border-white/10 transform transition hover:scale-105 cursor-pointer z-20">
                <video id="local-video" autoplay playsinline muted
                    class="w-full h-full object-cover transform scale-x-[-1]"></video>
            </div>

            <!-- Controls Bar -->
            <div
                class="absolute bottom-0 left-0 right-0 pb-8 pt-24 flex justify-center gap-4 md:gap-8 bg-gradient-to-t from-black/90 via-black/50 to-transparent z-10 pointer-events-auto">
                <button onclick="toggleMute()" id="mute-btn"
                    class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white backdrop-blur-md border border-white/10 flex items-center justify-center transition hover:scale-110">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                        </path>
                    </svg>
                </button>

                <button onclick="endCallSignal()"
                    class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-600/30 flex items-center justify-center transition transform hover:scale-110 border-4 border-slate-900/50">
                    <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.516l2.257-1.13a1 1 0 00.502-1.21L8.228 8.02A1 1 0 007.28 7H6a2 2 0 00-2 2v1z">
                        </path>
                    </svg>
                </button>

                <button onclick="toggleCam()" id="cam-btn"
                    class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white backdrop-blur-md border border-white/10 flex items-center justify-center transition hover:scale-110">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    </div>

    <!-- Global 3D Background Script -->
    <script src="js/background-3d.js"></script>

    <script>
        // --- STATE ---
        let currentChatId = null;
        let currentChatName = '';
        const token = localStorage.getItem('token');
        const myUsername = localStorage.getItem('username');
        const myId = parseJwt(token).id;

        // --- SOCKET ---
        const socket = io();
        let localStream;
        let peerConnection;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let callTimerInt;

        if (!token) location.href = 'index.html';

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return {}; }
        }

        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
            sb.classList.toggle('absolute'); // Mobile handling
        }

        // --- PRESENCE LOGIC ---
        const activeUsersSet = new Set();

        // Emit presence on load
        socket.on('connect', () => {
            socket.emit('user-online', myUsername);
        });

        // 1. Initial Load of Online Users
        socket.on('active-users-list', (users) => {
            users.forEach(u => activeUsersSet.add(u));
            updatePresenceUI();
        });

        // 2. Real-time Status Updates
        socket.on('user-status', (data) => {
            if (data.status === 'online') {
                activeUsersSet.add(data.username);
            } else {
                activeUsersSet.delete(data.username);
            }
            updatePresenceUI();

            // Update Active Chat Header if open
            if (data.username === currentChatName) {
                updateHeaderStatus(data.status === 'online');
            }
        });

        function updatePresenceUI() {
            // Re-render conversation list to show green dots
            loadConversations();
        }

        function updateHeaderStatus(isOnline) {
            const statusEl = document.getElementById('chat-status');
            if (isOnline) {
                statusEl.classList.remove('hidden');
                statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online`;
            } else {
                statusEl.innerHTML = `<span class="text-slate-500">Offline</span>`;
            }
        }

        // --- SIDEBAR LOGIC ---
        // Modify loadConversations to use activeUsersSet
        async function loadConversations() {
            try {
                const res = await fetch('/api/chat/conversations', { headers: { 'Authorization': token } });
                const list = await res.json();
                const container = document.getElementById('conversationsList');

                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-48 text-slate-500 opacity-60">
                            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            <p class="text-sm">No chats yet</p>
                        </div>`;
                    return;
                }

                container.innerHTML = list.map(c => {
                    const isOnline = activeUsersSet.has(c.username);
                    const isActive = currentChatId === c.id;
                    return `
                    <div onclick="selectUser(${c.id}, '${c.username}')" 
                        class="chat-item p-3 rounded-xl cursor-pointer flex items-center gap-3 transition group relative overflow-hidden ${isActive ? 'active bg-white/5' : 'hover:bg-white/5'}">
                        
                        <!-- Avatar -->
                        <div class="relative w-12 h-12 flex-shrink-0">
                             <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-white font-bold border border-white/10 ${isOnline ? 'ring-2 ring-emerald-500 shadow-lg shadow-emerald-500/20' : ''}">
                                <span class="text-lg">${c.username[0].toUpperCase()}</span>
                            </div>
                            ${isOnline ? '<div class="absolute bottom-0.5 right-0.5 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full z-10"></div>' : ''}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h4 class="font-bold text-slate-200 truncate group-hover:text-white transition ${isActive ? 'text-white' : ''}">${c.username}</h4>
                                <span class="text-[10px] ${isActive ? 'text-emerald-400' : 'text-slate-500'} font-medium">${timeAgo(c.messaged_at)}</span>
                            </div>
                            <p class="text-xs truncate ${isActive ? 'text-slate-300' : 'text-slate-400'} group-hover:text-slate-300 transition">
                                ${c.msg_type === 'text' ? (c.sender_username === myUsername ? '<span class="opacity-60">You: </span>' : '') + c.content : 'üìé Attachment'}
                            </p>
                        </div>
                    </div>
                `}).join('');
            } catch (e) { console.error(e); }
        }

        async function searchUsers(q) {
            if (q.length < 1) { loadConversations(); return; }
            const res = await fetch(`/api/chat/search?q=${q}`, { headers: { 'Authorization': token } });
            const users = await res.json();
            const container = document.getElementById('conversationsList');

            container.innerHTML = users.length ? users.map(u => {
                const isOnline = activeUsersSet.has(u.username);
                return `
                <div onclick="selectUser(${u.id}, '${u.username}')" class="chat-item p-3 rounded-xl hover:bg-white/5 cursor-pointer flex items-center gap-3 transition group">
                   <div class="relative w-12 h-12 flex-shrink-0">
                        <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-emerald-400 font-bold border border-white/5 group-hover:border-emerald-500/50 transition">
                            <span class="text-lg">üîç</span>
                        </div>
                         ${isOnline ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full"></div>' : ''}
                    </div>
                    <p class="font-bold text-slate-200 group-hover:text-white transition">${u.username}</p>
                </div>
            `}).join('') : '<div class="text-center text-slate-500 text-sm mt-10">No farmers found</div>';
        }

        // --- CHAT LOGIC ---
        function selectUser(id, name) {
            currentChatId = id;
            currentChatName = name;

            // Update Header
            document.getElementById('chat-name').innerText = name;
            document.getElementById('header-avatar').innerText = name[0].toUpperCase();
            document.getElementById('header-avatar').classList.remove('hidden');
            document.getElementById('chat-status').classList.remove('hidden');
            document.getElementById('call-actions').classList.remove('hidden');

            // Set Initial Status based on Real-Time Data
            const isOnline = activeUsersSet.has(name);
            updateHeaderStatus(isOnline);

            // Enable Inputs
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // Load Content
            loadMessages();
            loadConversations(); // Refresh highlighting

            // Mobile: Close sidebar
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // --- VOICE RECORDER ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;

                // Mime Type Detection
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    isRecording = false;
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const file = new File([audioBlob], "voice_msg.webm", { type: mimeType });

                    if (audioBlob.size < 100) return;

                    const formData = new FormData();
                    formData.append('media', file);
                    formData.append('content', 'Voice Message');

                    const btn = document.getElementById('recordBtn');
                    btn.classList.add('text-green-500');

                    try {
                        const res = await fetch(`/api/chat/${currentChatId}`, {
                            method: 'POST', body: formData, headers: { 'Authorization': token }
                        });
                        if (res.ok) {
                            loadMessages();
                            loadConversations();
                        }
                    } catch (e) {
                        alert("Failed to send voice message");
                    }

                    stream.getTracks().forEach(t => t.stop());
                    audioChunks = [];
                    document.getElementById('recording-ui').classList.add('hidden');
                    btn.classList.remove('text-green-500');
                };

                mediaRecorder.start();
                document.getElementById('recording-ui').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("Microphone access denied: " + e.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        function cancelRecording() {
            if (mediaRecorder) {
                mediaRecorder.onstop = null;
                mediaRecorder.stop();
                isRecording = false;
                audioChunks = [];
                document.getElementById('recording-ui').classList.add('hidden');
                if (mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(t => t.stop());
            }
        }

        // --- POLLING & RENDERING ---
        let lastMsgCount = 0;

        // --- TYPING INDICATOR ---
        const msgInput = document.getElementById('msgInput');
        let typingTimeout;

        msgInput.addEventListener('input', () => {
            if (!currentChatId) return;
            socket.emit('typing', { chatId: currentChatId, username: myUsername });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop-typing', { chatId: currentChatId, username: myUsername });
            }, 1000);
        });

        socket.on('typing', (data) => {
            if (data.chatId == currentChatId && data.username !== myUsername) {
                document.getElementById('chat-status').classList.remove('hidden');
                document.getElementById('chat-status').innerHTML = `<span class="animate-pulse font-bold text-green-400">Typing...</span>`;
            }
        });

        socket.on('stop-typing', (data) => {
            if (data.chatId == currentChatId && data.username !== myUsername) {
                const isOnline = activeUsersSet.has(data.username);
                updateHeaderStatus(isOnline);
            }
        });

        // --- SMART REPLIES ---
        function generateSmartReplies(lastMsg) {
            const replies = [];
            const m = lastMsg.toLowerCase();

            if (m.includes('price') || m.includes('cost')) replies.push("It is ‚Çπ50/kg", "Market price is high", "Let's negotiate");
            else if (m.includes('hello') || m.includes('hi')) replies.push("Namaste! üôè", "Hello, how are you?", "Any updates?");
            else if (m.includes('available') || m.includes('stock')) replies.push("Yes, available.", "Out of stock currently.", "Check my profile.");
            else if (m.includes('thank')) replies.push("You're welcome!", "No problem.", "Happy to help.");
            else replies.push("Okay üëç", "I will call you.", "Send me details.");

            const container = document.getElementById('smart-replies');
            container.innerHTML = replies.map(r => `
                <button onclick="sendSmartReply('${r}')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-white/10 rounded-full text-xs text-slate-300 transition whitespace-nowrap">
                    ${r}
                </button>
            `).join('');
            container.classList.remove('hidden');
        }

        function sendSmartReply(text) {
            document.getElementById('msgInput').value = text;
            document.getElementById('smart-replies').classList.add('hidden');
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }

        async function loadMessages() {
            if (!currentChatId) return;
            const res = await fetch(`/api/chat/${currentChatId}`, { headers: { 'Authorization': token } });
            const msgs = await res.json();

            if (msgs.length === lastMsgCount) return;
            lastMsgCount = msgs.length;

            const container = document.getElementById('msgContainer');
            container.innerHTML = msgs.map(m => {
                const isMe = m.sender_username === myUsername;
                let contentHtml = '';

                if (m.msg_type === 'image') contentHtml = `<img src="${m.media_url}" class="rounded-lg max-w-full h-auto mt-1 border border-white/10 cursor-pointer hover:scale-105 transition">`;
                else if (m.msg_type === 'video') contentHtml = `<video src="${m.media_url}" controls class="rounded-lg max-w-full h-auto mt-1 border border-white/10"></video>`;
                else if (m.msg_type === 'audio') contentHtml = `<audio src="${m.media_url}" controls class="mt-1 w-64 h-10"></audio>`;
                else contentHtml = `<p>${m.content}</p>`;

                return `
                    <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'}">
                        <div class="msg-bubble ${isMe ? 'my-msg' : 'their-msg'}">
                            ${!isMe ? `<div class="text-[10px] font-bold opacity-50 mb-1">${m.sender_username}</div>` : ''}
                            ${contentHtml}
                            <div class="text-[9px] opacity-60 text-right mt-1">${new Date(m.messaged_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;

            if (msgs.length > 0) {
                const last = msgs[msgs.length - 1];
                if (last.sender_username !== myUsername && last.msg_type === 'text') {
                    generateSmartReplies(last.content);
                } else {
                    document.getElementById('smart-replies')?.classList.add('hidden');
                }
            }
        }

        setInterval(() => {
            if (currentChatId) loadMessages();
        }, 1000); // 1s polling for "Real Time" feel

        setInterval(loadConversations, 5000);
        loadConversations();

        // --- MESSAGING ---
        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('attachment-preview').classList.remove('hidden');
                document.getElementById('file-name').innerText = file.name;
            }
        }
        function clearAttachment() {
            document.getElementById('mediaInput').value = '';
            document.getElementById('attachment-preview').classList.add('hidden');
        }

        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const content = document.getElementById('msgInput').value;
            const fileInput = document.getElementById('mediaInput');

            if (!content.trim() && !fileInput.files.length) return;

            const formData = new FormData();
            formData.append('content', content);
            if (fileInput.files.length) formData.append('media', fileInput.files[0]);

            document.getElementById('msgInput').value = '';
            clearAttachment();

            const res = await fetch(`/api/chat/${currentChatId}`, {
                method: 'POST',
                headers: { 'Authorization': token },
                body: formData
            });

            if (res.ok) {
                loadMessages();
                loadConversations();
            }
        };

        // --- UTILS ---
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            return Math.floor(hours / 24) + 'd ago';
        }

        // --- ADVANCED CALLING LOGIC (Instagram-style) ---
        let incomingCallData = null;

        // Emit presence (handled in connect now)
        // socket.emit('user-online', myUsername);

        socket.on('incoming-call', (data) => {
            if (data.targetUsername !== myUsername) return;
            incomingCallData = data;

            // Show Incoming Call Modal
            const modal = document.getElementById('call-modal');
            modal.classList.remove('hidden');
            document.getElementById('call-status-text').innerText = `Incoming Call from ${data.callerName}`;

            // Add Accept/Decline Buttons dynamically if not exists
            if (!document.getElementById('accept-btn')) {
                const controls = document.querySelector('#call-modal .absolute.bottom-0');
                controls.innerHTML = `
                    <button onclick="rejectCall()" class="w-16 h-16 rounded-full bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg transition flex items-center justify-center transform hover:scale-110">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <button onclick="acceptCall()" id="accept-btn" class="w-16 h-16 rounded-full bg-emerald-500 hover:bg-emerald-400 text-white font-bold shadow-lg transition animate-bounce flex items-center justify-center transform hover:scale-110">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    </button>
                `;
            }
        });

        socket.on('call-started', async (data) => {
            if (isCaller && data.roomId === currentRoomId) {
                // Partner accepted
                document.getElementById('call-status-text').innerText = "Connecting...";
                initializeWebRTC(data.roomId);
            }
        });

        socket.on('call-ended', (data) => {
            if (data.roomId === currentRoomId) {
                endCallUI();
                alert("Call Ended / Rejected");
            }
        });

        let isCaller = false;
        let currentRoomId = null;

        async function startCall(type) {
            isCaller = true;
            currentRoomId = `call_${[currentChatName, myUsername].sort().join('_')}`;

            // Show Calling UI
            document.getElementById('call-modal').classList.remove('hidden');
            document.getElementById('call-status-text').innerText = `Calling ${currentChatName}...`;

            // Show End Button only
            const controls = document.querySelector('#call-modal .absolute.bottom-0');
            controls.innerHTML = `
                <button onclick="endCallSignal()" class="w-16 h-16 rounded-full bg-red-600 hover:bg-red-500 text-white font-bold flex items-center justify-center transform hover:scale-110 transition">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>`;

            socket.emit('call-request', {
                roomId: currentRoomId,
                callerName: myUsername,
                targetUsername: currentChatName
            });
        }

        async function acceptCall() {
            const roomId = incomingCallData.roomId;
            currentRoomId = roomId;
            isCaller = false;

            // Update UI/Restore Controls
            document.getElementById('call-status-text').innerText = "Connected";
            restoreCallControls(); // Helper to put back Mute/Cam/End buttons

            socket.emit('call-accepted', { roomId });
            initializeWebRTC(roomId);
        }

        function rejectCall() {
            socket.emit('call-rejected', { roomId: incomingCallData.roomId });
            endCallUI();
        }

        function endCallSignal() {
            socket.emit('call-rejected', { roomId: currentRoomId }); // Re-use rejected for cancel
            endCallUI();
        }

        function endCallUI() {
            document.getElementById('call-modal').classList.add('hidden');
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            clearInterval(callTimerInt);
        }

        function restoreCallControls() {
            const controls = document.querySelector('#call-modal .absolute.bottom-0');
            controls.innerHTML = `
                <button onclick="toggleMute()" id="mute-btn"
                    class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white backdrop-blur-md border border-white/10 flex items-center justify-center transition hover:scale-110">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>
                
                <button onclick="endCallSignal()"
                    class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-600/30 flex items-center justify-center transition transform hover:scale-110 border-4 border-slate-900/50">
                    <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.516l2.257-1.13a1 1 0 00.502-1.21L8.228 8.02A1 1 0 007.28 7H6a2 2 0 00-2 2v1z"></path></svg>
                </button>
                
                <button onclick="toggleCam()" id="cam-btn"
                    class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white backdrop-blur-md border border-white/10 flex items-center justify-center transition hover:scale-110">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
             `;
        }

        async function initializeWebRTC(roomId) {
            // Restore standard WebRTC logic
            startTimer();
            const constraints = { audio: true, video: true };
            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('local-video').srcObject = localStream;

                socket.emit('join-room', roomId, myUsername);
                peerConnection = new RTCPeerConnection(rtcConfig);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    document.getElementById('remote-video').srcObject = event.streams[0];
                };
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) socket.emit('ice-candidate', { roomId, candidate: event.candidate });
                };

                if (isCaller) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('offer', { roomId, offer });
                }
            } catch (e) { alert("Media Error: " + e.message); endCallUI(); }
        }

        socket.on('offer', async (data) => {
            // Logic: If we already accepted the call via UI (currentRoomId matches), process automatically.
            // If not (unexpected offer), we might ignore or show UI (but for now let's assume UI flow handled it).

            if (data.roomId !== currentRoomId) return; // Ignore stray offers

            try {
                // Ensure PeerConnection exists (it should from initializeWebRTC)
                if (!peerConnection) {
                    console.error("PeerConnection missing on offer receipt. Re-initializing...");
                    await initializeWebRTC(data.roomId);
                }

                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', { roomId: data.roomId, answer });

                // Update specific UI status
                document.getElementById('call-status-text').innerText = "Connected";
            } catch (e) {
                console.error("Offer Error:", e);
                // endCallUI(); // Don't kill it immediately, retry?
            }
        });

        socket.on('answer', async (data) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        socket.on('ice-candidate', async (data) => {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        });

        function endCall() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (peerConnection) peerConnection.close();
            document.getElementById('call-modal').classList.add('hidden');
            clearInterval(callTimerInt);
            // Optionally reload to clean WebRTC state completely
            // window.location.reload(); 
        }

        // --- AUTO-CHAT LOGIC ---
        // Check if we need to open a chat with a specific user from URL params (e.g. from Trade Hub)
        const urlParams = new URLSearchParams(window.location.search);
        const targetUser = urlParams.get('chat_with');
        if (targetUser) {
            console.log("Auto-initiating chat with:", targetUser);
            document.getElementById('userSearch').value = targetUser;
            // Delay slightly to ensure UI is ready
            setTimeout(() => {
                searchUsers(targetUser);
                // Note: The user still has to click the result, or we can improve searchUsers to auto-select if exact match.
                // For now, pre-filling search is a massive help.
            }, 500);
        }

        const aiQuery = urlParams.get('ai_query');
        if (aiQuery) {
            document.getElementById('msgInput').value = aiQuery;
            document.getElementById('msgInput').focus();
        }

        function startTimer() {
            let sec = 0;
            const el = document.getElementById('call-timer');
            clearInterval(callTimerInt);
            callTimerInt = setInterval(() => {
                sec++;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                el.innerText = `${m}:${s}`;
            }, 1000);
        }

        function toggleMute() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('mute-btn').innerText = track.enabled ? 'üé§' : 'üîá';
        }
        function toggleCam() {
            const track = localStream.getVideoTracks()[0];
            if (track) track.enabled = !track.enabled;
            else alert("No video track.");
        }
    </script>
    <script src="js/background-3d.js"></script>
    <script src="js/global-ticker.js"></script>
    <script src="js/mobile-nav.js"></script>
</body>

</html>